name: Production

on:
    push:
        branches:
            - main

jobs:
    build:
        uses: ./.github/workflows/build.yml

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Inject slug/short variables
              uses: rlespinasse/github-slug-action@v4.x

            - name: SSH and Docker Pull
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  password: ${{ secrets.VPS_PASSWORD }}
                  script: |
                      echo ${{secrets.DOCKER_TOKEN}} | docker login --username ${{secrets.DOCKER_USERNAME}} --password-stdin 2> /dev/null
                      docker service update --image domesday/heurly:main prod_pheurly

            - name: Discord notification
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
                  DISCORD_EMBEDS: '[{"title": "Deployment - Link of ${{ env.GITHUB_REF_SLUG }} (Prod)", "description": "[${{ github.repository }}] Branch ${{ env.GITHUB_REF_SLUG }} has been deployed.", "url": "https://heurly.fr", "color": 14847590}]'
              uses: Ilshidur/action-discord@master
              with:
                  args: ""
                  # Ã©tape pour ajouter le reverse proxy
